cputypeid=$(shell echo f$$(lscpu|grep '^CPU family:'|tr -cd [0-9])m$$(lscpu|grep '^Model:'|tr -cd [0-9])s$$(lscpu|grep '^Stepping:'|tr -cd [0-9]))
ncores=$(shell echo $$(grep "^core id" /proc/cpuinfo|sort -u|wc -l)*$$(grep "^physical id" /proc/cpuinfo|sort -u|wc -l)|bc)
nprocessors=$(shell echo $$(grep "^processor" /proc/cpuinfo|wc -l))
cc=$(shell dpkg -l|tr -s [:blank:] ' '|grep "^ii g++"|cut -f2 -d' '|sort|tail -n1)
ccopt=-std=c++11 -Wall -Wextra -Wno-unused-parameter -O3 -march=native -ffast-math -flto -fopenmp
pwd=$(shell echo $(PWD))

compile:
	@grep -sq "$(cputypeid)" utils/cpuinfo.hpp || { \
		echo "/* This file is automatically generated by makefile $(cputypeid) */" > utils/cpuinfo.hpp; \
		echo "#ifndef __CPUINFO_HPP__" >> utils/cpuinfo.hpp; \
		echo "#define __CPUINFO_HPP__" >> utils/cpuinfo.hpp; \
		echo "#define NCORES $(ncores)" >> utils/cpuinfo.hpp; \
		echo "#define NPROCESSORS $(nprocessors)" >> utils/cpuinfo.hpp; \
		echo "#endif" >> utils/cpuinfo.hpp; \
	}
	@mkdir -p ../bin
	@$(cc) $(ccopt) -I "." -o ../bin/ranklib main.cpp

clean:
	@rm -f *~ ../bin/*

run:
	@../bin/ranklib || echo "ERROR EXIT CODE $$?"

edit:
	@geany $$(cpptree ./main.cpp) --new-instance > /dev/null 2>&1 &

rsync:
	@rsync -quaRc --delete . gabriele@barbera1.isti.cnr.it:$(pwd)
	@rsync -quaRc --delete . gabriele@node1.novello.isti.cnr.it:$(pwd)

dataset:
	@mkdir -p ../bin
	@mkdir -p /tmp/ranklibpp
	@$(cc) -O3 rds.cpp -o ../bin/rds
	@../bin/rds ../datasets/rand/train.txt 150 750000 5 100
	@../bin/rds ../datasets/rand/vali.txt 150 100000 5 100
	@../bin/rds ../datasets/rand/test.txt 150 10000 5 100

test:
	@mkdir -p ../bin
	@$(cc) $(ccopt) -I "." -o ../bin/test test.cpp && ../bin/test

valgrind:
	@valgrind --tool=memcheck --leak-check=full ../bin/ranklib
